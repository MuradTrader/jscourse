Отлично! Давайте разберем этот урок о **Equality Narrowing** (Сужение типов на основе равенства).

### Общий обзор видео

Автор представляет еще один тип Type Guard в TypeScript — **Equality Narrowing**. Это техника, которая позволяет TypeScript сужать типы на основе проверок равенства (`===`, `!==`, `==`, `!=`). Особенно полезно при работе с объединенными типами (union types).

---

### Детальное объяснение по шагам

#### 1. Определение Equality Narrowing

**Что говорит автор:**
Equality narrowing — это техника сужения, которая помогает компилятору TypeScript вывести более конкретный тип на основе проверок равенства.

**Подробное объяснение:**

- **Проверки равенства:** `===`, `!==`, `==`, `!=`
- **Особенная польза:** При работе с объединенными типами (union types), где переменная может иметь несколько возможных типов
- **Суть:** Когда TypeScript видит проверку равенства, он может исключить некоторые типы из объединения, основываясь на этой проверке

#### 2. Создание системы типов для геометрических фигур

**Что говорит автор:**
Создает два типа — `Circle` и `Square`, а затем объединяет их в тип `Shape`.

**Подробное объяснение кода:**

```typescript
// Тип для круга
type Circle = {
  kind: "circle"; // Литеральный тип "circle"
  radius: number;
};

// Тип для квадрата
type Square = {
  kind: "square"; // Литеральный тип "square"
  sideLength: number;
};

// Объединенный тип - может быть либо Circle, либо Square
type Shape = Circle | Square;
```

**Ключевые моменты:**

- **`kind: "circle"` и `kind: "square"`:** Это **литеральные типы** (literal types). TypeScript рассматривает `"circle"` и `"square"` как отдельные типы, а не просто как строки.
- **Discriminated Union (Размеченное объединение):** Паттерн, где у каждого члена объединения есть общее свойство (в данном случае `kind`), которое позволяет их различать.

#### 3. Функция getArea и Equality Narrowing в действии

**Что говорит автор:**
Создает функцию `getArea`, которая вычисляет площадь фигуры, используя equality narrowing для определения типа фигуры.

**Подробное объяснение кода:**

```typescript
function getArea(shape: Shape): number {
  if (shape.kind === "circle") {
    // Внутри этого блока TypeScript знает, что shape - это Circle
    return Math.PI * shape.radius ** 2;
  } else {
    // В этом блоке TypeScript знает, что shape - это Square
    return shape.sideLength ** 2;
  }
}
```

**Как работает Equality Narrowing в этом примере:**

1. **До условия:** Тип `shape` — `Circle | Square`
2. **Проверка `shape.kind === "circle"`:**
   - TypeScript анализирует: "если `shape.kind` равно литералу `"circle"`, то это должен быть тип `Circle`"
   - TypeScript исключает тип `Square` из объединения, так как у `Square` свойство `kind` всегда равно `"square"`
3. **Внутри блока `if`:** Тип `shape` сужается до `Circle`
4. **В блоке `else`:** TypeScript автоматически понимает, что оставшийся возможный тип — это `Square`

#### 4. Преимущества Equality Narrowing

**Что говорит автор:**
Подчеркивает, что благодаря этой технике не нужно проверять наличие всех свойств вручную.

**Подробное объяснение преимуществ:**

**Без Equality Narrowing (гипотетически):**

```typescript
// Так пришлось бы делать без equality narrowing:
if ("radius" in shape) {
  // Но это ненадежно - что если в будущем добавится другая фигура с радиусом?
  return Math.PI * shape.radius ** 2;
}
```

**С Equality Narrowing:**

```typescript
// Надежно и понятно
if (shape.kind === "circle") {
  // TypeScript гарантирует, что shape имеет все свойства Circle
  return Math.PI * shape.radius ** 2;
}
```

**Ключевые преимущества:**

1. **Безопасность:** TypeScript гарантирует, что вы обращаетесь к правильным свойствам
2. **Удобство:** Не нужно проверять наличие каждого свойства
3. **Расширяемость:** Если добавить новый тип фигуры (например, `Triangle`), TypeScript сразу укажет на места, где нужно обновить логику

#### 5. Анализ работы TypeScript

**Подробное объяснение процесса сужения типов:**

```typescript
function getArea(shape: Shape): number {
  // ДО условия: shape имеет тип Circle | Square

  if (shape.kind === "circle") {
    // ВНУТРИ условия: shape имеет тип Circle
    // TypeScript знает, что shape.radius существует и является number
    return Math.PI * shape.radius ** 2; // Безопасный доступ к radius
  } else {
    // В else блоке: shape имеет тип Square
    // TypeScript знает, что shape.sideLength существует и является number
    return shape.sideLength ** 2; // Безопасный доступ к sideLength
  }
}
```

---

### Ключевые выводы из этого урока

1. **Equality Narrowing — мощный Type Guard:** Проверки равенства (`===`, `!==`) используются TypeScript для сужения типов.

2. **Идеально для Discriminated Unions:** Особенно полезно, когда у членов объединения есть общее свойство-дискриминатор (в примере — `kind`).

3. **Литеральные типы как дискриминаторы:** Свойства с литеральными типами (`"circle"`, `"square"`) отлично подходят для различения типов в объединениях.

4. **Автоматическое исключение типов:** TypeScript автоматически исключает невозможные типы из объединения на основе проверок равенства.

### Почему это лучше альтернативных подходов?

| Подход                                             | Проблемы                                                  | Equality Narrowing                      |
| :------------------------------------------------- | :-------------------------------------------------------- | :-------------------------------------- |
| **Проверка наличия свойств** (`"radius" in shape`) | Ненадежно, если несколько типов имеют одинаковые свойства | Надежно, основано на дискриминаторе     |
| **Type Guards вручную**                            | Требует написания дополнительных функций                  | Встроено в язык, работает автоматически |
| **Type assertion (приведение типа)**               | Небезопасно, можно ошибиться                              | Безопасно, проверяется компилятором     |

### Расширяемость примера

Автор намекает на важное преимущество: если добавить новый тип:

```typescript
type Triangle = {
  kind: "triangle";
  base: number;
  height: number;
};

type Shape = Circle | Square | Triangle; // Добавляем Triangle
```

TypeScript сразу укажет, что функция `getArea` не обрабатывает все случаи, и потребует добавить обработку для `"triangle"`.

---

### Итог

Equality Narrowing — это элегантный и надежный способ работы с объединенными типами в TypeScript. Он сочетает мощь статической типизации с интуитивно понятным подходом, который хорошо знаком разработчикам из JavaScript.

Этот механизм особенно ценен в крупных проектах, где важно сохранять типобезопасность при работе с разнородными данными.
